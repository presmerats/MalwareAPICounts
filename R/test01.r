
library(jsonlite)
library(data.table)
setwd("/home/homero/KDB/Projectes/dakd-project/R")
# trying to flatten
# https://www.opencpu.org/posts/jsonlite-a-smarter-json-encoder/
jsonData <- fromJSON(txt = "../luigi/lvl4/binaries_labelled.df")

# subset for playing
data2 <- jsonData[c(1:10),c('name','apistats')]

for (elem in colnames(data2$apistats)){
  
  for (i in colnames(data2$apistats[[elem]]) ) {
    if (i=="GetSystemInfo"){
      print(elem)
      print(i)
      print(data2$apistats[[elem]][[i]])
    }
  }
  
}

# idea 3
# replace NA by 0
# sum columns with similar name 2800.GetSystemInfo + 2901.GetSystemInfo

# Flattening sub dataframes!!
apistatscols=do.call(rbind, lapply(data2[c('apistats')], '[[', '2900'))
apistatscols2=do.call(rbind, lapply(data2[c('apistats')], '[[', '2948'))
apistatscols3=do.call(rbind, lapply(data2[c('apistats')], '[[', '1652'))
x1 <- apistatscols$"CreateThread"
x2 <- apistatscols2$"CreateThread"
x3 <- apistatscols3$"CreateThread"
x1[is.na(x1)] <- 0
x2[is.na(x2)] <- 0
x3[is.na(x3)] <- 0
CreateThread = x1 + x2 + x3
CreateThread

# create a loop for the previous set of operations on the data frame
input.frame <- jsonData[c(1:100),c('name','apistats')]

flat.frame <- data.frame(name=input.frame$name)
for (elem in colnames(input.frame$apistats)){
  #get the corresponding apistats associated with an element
  current_apistats =  do.call(rbind, lapply(input.frame[c('apistats')], '[[', elem))
 
  # for each api call of that apistats, create a new column 
  for (i in colnames(current_apistats) ) {
    
    # get as a new colum/vector
    x <- current_apistats[[i]]
    
    # transform NA's to 0
    x[is.na(x)] <- 0
    
    
    # if it already exists, just sum the values of each row
    if(i %in% colnames(flat.frame)){
      flat.frame[[i]] <- flat.frame[[i]] + x
        
    } else {
      # if that column name doesn't exists, append it to the data frame
      flat.frame[[i]] <-  x
    }
    
    #print(head(flat.frame[,c(1,2,length(colnames(flat.frame))-1, length(colnames(flat.frame)))],20))
    
  }
  
}

###############

apistatscolsone=do.call(rbind, lapply(data2[c('apistats')], '['))
names(apistatscolsone)



procmoncols=do.call(rbind, lapply(jsonData[c('procmon')], '['))
names(procmoncols)

hashcols=do.call(rbind, lapply(jsonData[c('hash')], '['))
names(hashcols)

# append cols into a dataframe..
data <- data.frame(name=jsonData$name,label=jsonData$label, hashcols, apistatscols, procmoncols )




colnames(data2)
nrow(data2)
ncol(data2)
ncol(data2$apistats)
nrow(data2$apistats)
colnames(data2$apistats)



#https://stackoverflow.com/questions/41988928/how-to-parse-json-in-a-dataframe-column-using-r

f <- function(json, id){
  tmp <- jsonlite::fromJSON(json)
  
  tmp <- as.data.frame(tmp)
  
  tmp$id <- id
  
  return(tmp)
}
json_dfs <- mapply(f, data2$apistats, data2$name, SIMPLIFY = FALSE )


f2 <- function(json, id){
  
  tmp <- as.data.frame(json)
  
  tmp$id <- id
  
  return(tmp)
}

json_dfs <- mapply(f2, data2$apistats, data2$name, SIMPLIFY = FALSE )

clean_df <- data.table::rbindlist(json_dfs)

head(clean_df,1)



my.array = array(0, 
    dim=c(2,3,4), dimnames=list( 
      d1=c("A1","A2"),
      d2=c("B1","B2","B3"), 
      d3=c("C1","C2","C3","C4")) ) 
View(my.array)

#implement the idea with for loops
colnames(data2)
for ( i in length(data2)){
  print(length(data2[1]))
}

# dim(jsonData)
# dim(data2)
# dim(data2[c('apistats')])
# head(data2[c('apistats')])
# head(data2)

data3 <- data2[c('apistats')]
data3 <- data3$apistats[,1:2]
head(data3)
colnames(data3)

level1 <- lapply(data3, '[')
level2 <- lapply(level1, '[')
head(level2, 2)
lapply(data3, '[[', '2800')
lapply(data2[c('apistats')], '[[', '2800')

# idea flatten one level then flatten again the second level

# then flatten 

apistatscols=do.call(rbind, lapply(data2[c('apistats')], '[[', '2900'))
names(apistatscols)
apistatscols$bind

names(jsonData)
jsonData$label
jsonData$name
names(jsonData$apistats)
names(jsonData$procmon)
names(jsonData$hash)
jsonData$hash$sha256

# goal flatten name, label, hashcols.., apicols..., procmoncols...

# rename every apistats subcolumn to 2900 or whatever



# and add a 0 if no value for col
apicols = names(jsonData$apistats$"2900")
#iterate all apistats values, adding any new api name to the apicols list


procmoncols = names(jsonData$procmon)
procmoncols
hashcols = names(jsonData$hash)
hashcols

# Flattening sub dataframes!!
apistatscols=do.call(rbind, lapply(jsonData[c('apistats')], '[[', '2900'))
names(apistatscols)
apistatscols$bind


procmoncols=do.call(rbind, lapply(jsonData[c('procmon')], '['))
names(procmoncols)
procmoncols$"HKLM\\System\\Setup"

hashcols=do.call(rbind, lapply(jsonData[c('hash')], '['))
names(hashcols)
hashcols$"sha256"

# append cols into a dataframe..
data <- data.frame(name=jsonData$name,label=jsonData$label, hashcols, apistatscols, procmoncols )
names(data)
dim(data)





# Other tests

jsonData <- fromJSON(txt = "../luigi/mock/df/binaries.df")
names(jsonData)
head(jsonData)





# manual exploration
data <- t(jsonData)
for (i in 1:nrow(data)){
  print(data[i,1])
}


colum.names <- c("name","label", "sha256")

# saving to josn
mydf <- toJSON(jsonData, pretty=TRUE)
cat(mydf)


#data.table

library(data.table)


#dplyr
library(dplyr)
dim(jsonData)
names(jsonData)
nrow(jsonData)

#select
head(select(jsonData,testmeterpreter.res:apistats))

# melt
datamelt <- melt(jsonData, id=c("name","label","hash"), measure.vars=c(""))


# cast
#sumarizes



# flattening
library(jsonlite)
library(data.table)


jsonData <- fromJSON(txt = "../luigi/mock/df/binaries.df")
names(jsonData)
lapply(jsonData, function(x) {
  print(x)
  print("-------------------")
})
dim(jsonData)



# tell fromJSON we want a list back
json_data <- fromJSON("../luigi/mock/df/binaries.df", simplifyDataFrame=FALSE)
head(print(json_data))
# iterate over the list we have so we can "flatten" it then
# covert it back to a data.frame-like object
dat <- rbindlist(lapply(json_data, function(x) {
  as.list(unlist(x))
}), fill=TRUE)


#jsonlite
library(curl)
data1 <- fromJSON("https://api.github.com/users/hadley/orgs")
names(data1)
data1$login
data1$url

jsonData <- fromJSON(txt = "../luigi/mock/df/binaries.df")
names(jsonData)
jsonData$label
jsonData$name
names(jsonData$apistats)
names(jsonData$procmon)
names(jsonData$hash)
jsonData$hash$sha256


data2 <- fromJSON("https://api.github.com/users/hadley/repos")

#it's a data frame...
names(data2)
data2$name

#...with has a nested data frame
names(data2$owner)
data2$owner$login

#these are equivalent :)
data2[1,]$owner$login
data2[1,"owner"]$login
data2$owner[1,"login"]
data2$owner[1,]$login


