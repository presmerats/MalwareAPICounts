library(jsonlite)
library(data.table)
setwd("/home/homero/KDB/Projectes/dakd-project/R")

flatten.frame <- function(jsonData){
  flat.frame <- data.frame(name=jsonData$name, label=jsonData$label)
  
  
  
  # hash information
  hashcols=do.call(rbind, lapply(jsonData[c('hash')], '['))
  #hashcols$name <- jsonData$name
  names(flat.frame)
  names(hashcols)
  #nrow(hashcols)
  #nrow(flat.frame)
  flat.frame <- cbind(flat.frame, hashcols)
  names(flat.frame)
  
  head(hashcols)
  head(flat.frame)
  
  missing.Names <- function(name, md5){
    
    # print(length(xrow))
    # print(names(xrow))
    # print(colnames(xrow))
    # print(xrow[1])
    # print(xrow[5])
    # print(xrow[1]=="res")
    if (name=="res") {
      name <- paste("VirusShare_",md5,sep="")
    }
    #print(xrow)
    return(name)
  }
  
  
  flat.frame$name <-  mapply(missing.Names, flat.frame$name, flat.frame$md5)
  
  #flat.frame <- t(apply(flat.frame, 1, missing.Names ))
  colnames(flat.frame)
  #flat.frame
  head(flat.frame)
  tail(flat.frame)
  
  
  # apistats
  # create a loop for the previous set of operations on the data frame
  input.frame <- jsonData[,c('name','apistats')]
  
  for (elem in colnames(input.frame$apistats)){
    #get the corresponding apistats associated with an element
    current_apistats =  do.call(rbind, lapply(input.frame[c('apistats')], '[[', elem))
    
    # for each api call of that apistats, create a new column 
    for (i in colnames(current_apistats) ) {
      
      # get as a new colum/vector
      x <- current_apistats[[i]]
      
      # transform NA's to 0
      x[is.na(x)] <- 0
      
      
      # if it already exists, just sum the values of each row
      if(i %in% colnames(flat.frame)){
        flat.frame[[i]] <- flat.frame[[i]] + x
        
      } else {
        # if that column name doesn't exists, append it to the data frame
        #flat.frame <- cbind(flat.frame,x)
        flat.frame[[i]] <- x
      }
      
      #print(head(flat.frame[,c(1,2,length(colnames(flat.frame))-1, length(colnames(flat.frame)))],20))
      
    }
    
  }
  
  return(flat.frame)  
}
